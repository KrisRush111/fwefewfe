<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Небесное приключение | Платформер</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        dark: '#111827',
                        light: '#f3f4f6',
                        rcc: '#ec4899',
                        danger: '#ef4444',
                        success: '#10b981'
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(99, 102, 241, 0.5)',
                        'rcc-glow': '0 0 20px rgba(236, 72, 153, 0.8)',
                        'inner-glow': 'inset 0 0 15px rgba(255, 255, 255, 0.1)',
                        'modal-glow': '0 0 40px rgba(236, 72, 153, 0.6)'
                    }
                }
            }
        }
    </script>
    <style>
        
        @keyframes fadeInSlide {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(3deg); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        
        @keyframes glow {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
            100% { filter: brightness(1); }
        }
        
        @keyframes rcc-pulse {
            0% { box-shadow: 0 0 5px rgba(236, 72, 153, 0.7); }
            50% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.9); }
            100% { box-shadow: 0 0 5px rgba(236, 72, 153, 0.7); }
        }
        
        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }
        
             body {
            animation: fadeIn 0.5s ease-out;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            touch-action: manipulation;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            padding: 20px;
            color: #f3f4f6;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        html {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            height: 100%;
        }

           body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .game-container {
            animation: fadeInSlide 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
            background: rgba(17, 24, 39, 0.8);
            border-radius: 16px;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.3);
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 95%;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            overflow: hidden;
        }
        
        .player-avatar i {
            font-size: 30px;
            animation: glow 3s infinite;
        }
        
        .rcc-container {
            background-color: rgba(31, 41, 55, 0.7);
            border: 2px solid rgba(236, 72, 153, 0.5);
            border-radius: 8px;
            padding: 10px 20px;
            margin-bottom: 15px;
            width: 100%;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.3);
        }
        
        #gameCanvas {
            background: rgba(31, 41, 55, 0.7);
            border: none;
            border-radius: 8px;
            width: 100%;
            max-width: 700px;
            height: 400px;
            margin-bottom: 15px;
        }
        
        .controls-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
            justify-content: center;
            padding: 0 20px;
        }
        
        .control-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 50%;
            width: 90px;
            height: 90px;
            color: white;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            flex: 0 0 auto;
        }

        @media (max-width: 768px) {
            .control-btn {
                width: 80px;
                height: 80px;
                font-size: 30px;
            }
        }
        
        @media (max-width: 480px) {
            .control-btn {
                width: 70px;
                height: 70px;
                font-size: 28px;
            }
        }
        
        .control-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.7);
        }
        

        
        .key-helper {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .key {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(31, 41, 55, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .key span {
            background: rgba(99, 102, 241, 0.2);
            border-radius: 4px;
            padding: 3px 8px;
            font-weight: bold;
        }
        
        .footer {
            animation: fadeInSlide 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s both;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(17, 24, 39, 0.9);
            padding: 15px;
            width: 100%;
            max-width: 800px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .footer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
            gap: 5px;
            padding: 10px 15px;
            border-radius: 10px;
            width: 25%;
        }
        
        .footer-item:hover {
            transform: translateY(-5px);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .footer-item i {
            font-size: 24px;
            color: #8b5cf6;
        }
        
        .footer-item span {
            font-size: 12px;
            text-align: center;
        }
        
        #gameOverModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(17, 24, 39, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        #gameOverModal.active {
            opacity: 1;
            pointer-events: all;
        }

          #gameOverBackArrow {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(31, 41, 55, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
            z-index: 50;
            color: white;
        }
        
        #gameOverBackArrow:hover {
            transform: translateX(-3px);
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        #gameOverBackArrow i {
            color: white;
            font-size: 24px;
            transition: all 0.3s;
        }
        
        .modal-content {
            background: rgba(31, 41, 55, 0.9);
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            max-width: 90%;
            width: 500px;
            border: 1px solid rgba(236, 72, 153, 0.3);
            box-shadow: 0 0 50px rgba(236, 72, 153, 0.4);
            position: relative;
        }
        
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle var(--duration, 3s) infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .modal-btn {
            border: none;
            border-radius: 50px;
            padding: 12px 35px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .modal-btn i {
            font-size: 20px;
        }
        
        #restartButton {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
        }
        
        
        #backArrow:hover {
            transform: translateX(-3px);
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        #backArrow i {
            color: white;
            font-size: 24px;
            transition: all 0.3s;
        }
        
        #confirmationModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(17, 24, 39, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        #confirmationModal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .confirmation-content {
            background: rgba(31, 41, 55, 0.95);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            width: 450px;
            border: 1px solid rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 30px rgba(236, 72, 153, 0.4);
            position: relative;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .confirmation-btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .confirmation-btn:hover {
            transform: translateY(-2px);
        }
        
        .confirmation-btn:active {
            transform: translateY(0);
        }
        
        .btn-yes {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-no {
            background-color: #3b82f6;
            color: white;
        }
        
        .player-cloud {
            position: absolute;
            width: 80px;
            height: 20px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 20px;
            animation: float 3s infinite;
            opacity: 0.8;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
        }
        
        .player-cloud:nth-child(2n) {
            animation-delay: 0.5s;
            filter: blur(1px);
        }
        
        .player-cloud:nth-child(3n) {
            animation-delay: 1s;
        }
        
        .rcc-icon {
            color: #ec4899;
            font-size: 24px;
            animation: rcc-pulse 2s infinite;
        }
        
        @media (max-width: 768px) {
            .title-container h1 {
                font-size: 1.8rem;
            }
            
            .player-avatar {
                width: 50px;
                height: 50px;
            }
            
            .controls-container {
                gap: 15px;
                padding: 0 15px;
                margin-bottom: 30px;
            }
            
            .footer-item {
                padding: 8px 10px;
            }
            
            .footer-item i {
                font-size: 20px;
            }
            
            .footer-item span {
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
            }
            
            .title-container {
                margin-bottom: 15px;
            }
            
            .title-container h1 {
                font-size: 1.5rem;
            }
            
            .player-avatar {
                width: 40px;
                height: 40px;
            }
            
            .player-avatar i {
                font-size: 20px;
            }
            
            #backArrow {
                width: 40px;
                height: 40px;
                top: 15px;
                left: 15px;
            }
            
            .controls-container {
                gap: 10px;
                padding: 0 10px;
            }
            
            .key {
                font-size: 12px;
            }
            
            .key span {
                padding: 2px 6px;
            }
            
            .confirmation-content {
                padding: 20px;
            }
            
            .confirmation-btn {
                padding: 10px 20px;
                min-width: 100px;
            }
            
            .modal-btn {
                padding: 10px 25px;
                min-width: 140px;
            }
        }
    </style>
</head>
<body>
    <!-- Модальное окно подтверждения -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="confirmation-content">
            <h3 class="text-xl font-bold text-white mb-4">Вы точно хотите покинуть игру?</h3>
            <p class="text-gray-300 mb-6">На ваш счет пойдут только те RCC, что вы собрали за это время</p>
            <div class="confirmation-buttons">
                <button class="confirmation-btn btn-yes" id="confirmYes">Да</button>
                <button class="confirmation-btn btn-no" id="confirmNo">Нет</button>
            </div>
        </div>
    </div>
    
    <div class="game-container" style="position: relative;">
        <div class="back-arrow" id="backArrow" style="position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; border-radius: 50%; background: rgba(31, 41, 55, 0.7); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); z-index: 50;">
            <i class="fas fa-arrow-left" style="color: white; font-size: 24px;"></i>
        </div>
        <div class="title-container">
          
        
        </div>
        
        <div class="rcc-container">
            <i class="fas fa-gem rcc-icon"></i>
            <div class="flex flex-col items-center">
                <div class="text-sm text-purple-300">RCC</div>
                <div class="text-2xl font-bold text-white" id="score">0</div>
            </div>
            <i class="fas fa-gem rcc-icon"></i>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div class="controls-container">
            <button class="control-btn" id="leftButton">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button class="control-btn" id="jumpButton">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button class="control-btn" id="rightButton">
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    
    <div id="gameOverModal">
        <div class="modal-content">
             <div class="back-arrow" id="gameOverBackArrow">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="stars" id="modalStars"></div>
            <h2 class="text-3xl font-bold text-purple-400 mb-4">Игра окончена!</h2>
            <p class="text-xl mb-2">Вы упали с небесного пути</p>
            <p class="text-2xl font-bold mb-6 flex items-center justify-center gap-2">
                <i class="fas fa-gem text-pink-500"></i>
                <span>Ваш RCC: </span>
                <span id="finalScore">0</span>
                <i class="fas fa-gem text-pink-500"></i>
            </p>
            
            <div class="modal-buttons">
                <button class="modal-btn" id="restartButton">
                    <i class="fas fa-redo-alt"></i> Заново
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Создание звезд в модальном окне
        function createModalStars() {
            const starsContainer = document.getElementById('modalStars');
            const starCount = 50;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = `${Math.random() * 4}px`;
                star.style.height = star.style.width;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.setProperty('--duration', `${2 + Math.random() * 3}s`);
                star.style.animationDelay = `${Math.random() * 3}s`;
                starsContainer.appendChild(star);
            }
        }
        
        
function saveScoreAndRedirect() {
    const currentScore = gameState.rcc;

    // Получаем сохранённые данные из localStorage
    const savedData = JSON.parse(localStorage.getItem('raccoonClickerShared') || '{}');

    // Добавляем текущие RCC
    savedData.coins = (savedData.coins || 0) + currentScore;

    // Сохраняем обратно
    localStorage.setItem('raccoonClickerShared', JSON.stringify(savedData));

    // Переход на меню (или куда нужно)
    window.location.href = 'gamess.html';
}


        // Обработка выхода из игры
        document.getElementById('backArrow').addEventListener('click', () => {
            document.getElementById('confirmationModal').classList.add('active');
        });
        
      document.getElementById('confirmYes').addEventListener('click', () => {
    saveScoreAndRedirect(); // ← Заменено
});

document.getElementById('gameOverBackArrow').addEventListener('click', () => {
    saveScoreAndRedirect(); // ← Заменено
});

        
        document.getElementById('confirmNo').addEventListener('click', () => {
            document.getElementById('confirmationModal').classList.remove('active');
        });
        
     
        // Инициализация игры
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Установка размеров canvas
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        const GRAVITY = 0.4;
        const PLAYER_SIZE = 50;
        const JUMP_FORCE = -10;
        const PLATFORM_HEIGHT = 20;
        const PLATFORM_WIDTH = 100;
        const PLATFORM_GAP = 80; // Уменьшенное расстояние между платформами
        const SCROLL_SPEED = 7;
        const CRYSTAL_SIZE = 30;
        const PLATFORM_VERTICAL_GAP = 100;
        const MIN_HORIZONTAL_GAP = 50;
        const MAX_HORIZONTAL_GAP = 200;
        
        // Игровое состояние
        let gameState = {
            rcc: 0, // Теперь используем RCC вместо очков
            gameOver: false,
            player: {
                x: 0,
                y: 0,
                velX: 0,
                velY: 0,
                onGround: false,
                color: '#6366f1',
                rotation: 0
            },
            platforms: [],
            crystals: [],
            lastPlatformY: 0,
            keys: {
                left: false,
                right: false,
                jump: false
            },
            particleEffects: [],
            clouds: [],
            maxJumpHeight: JUMP_FORCE * 2.5 // Максимальная высота прыжка
        };
        
        // Создание начальной платформы (адаптировано под game.html)
        function createInitialPlatform() {
            gameState.platforms = [];
            gameState.crystals = [];
            gameState.clouds = [];
            
            // Создаем 8 платформ с шагом 100px как в game.html
            const platformCount = 1000;
            for (let i = 0; i < platformCount; i++) {
                const minX = 50;
                const maxX = canvas.width - PLATFORM_WIDTH - 50;
                const x = minX + Math.random() * (maxX - minX);
                const y = canvas.height - 50 - i * PLATFORM_VERTICAL_GAP;

                const platform = {
                    x: x,
                    y: y,
                    width: PLATFORM_WIDTH,
                    height: PLATFORM_HEIGHT,
                    color: '#93c5fd'
                };
                
                gameState.platforms.push(platform);
                gameState.lastPlatformY = y;
                
                // 40% шанс создать кристалл на платформе
                if (Math.random() < 0.4) {
                    createCrystal(x + Math.random() * (PLATFORM_WIDTH - CRYSTAL_SIZE), y - CRYSTAL_SIZE);
                }
            }

            // Ставим игрока на первую платформу
            const firstPlatform = gameState.platforms[0];
            gameState.player.x = firstPlatform.x + firstPlatform.width / 2 - PLAYER_SIZE / 2;
            gameState.player.y = firstPlatform.y - PLAYER_SIZE;
            
            // Создаем облака
            createClouds();
        }
        
        // Переписанная функция создания платформ с параметрами из game.html
        function createPlatform() {
            const lastPlatform = gameState.platforms[gameState.platforms.length - 1];
            const minX = 50;
            const maxX = canvas.width - PLATFORM_WIDTH - 50;
            let x = minX + Math.random() * (maxX - minX);
            
            // Проверка горизонтального промежутка
            if (lastPlatform) {
                const horizontalGap = Math.abs(x - lastPlatform.x);
                if (horizontalGap < MIN_HORIZONTAL_GAP || horizontalGap > MAX_HORIZONTAL_GAP) {
                    x = Math.max(minX, Math.min(maxX, lastPlatform.x + (Math.random() > 0.5 ? MIN_HORIZONTAL_GAP : MAX_HORIZONTAL_GAP)));
                }
            }
            
            const y = gameState.lastPlatformY - PLATFORM_GAP;
            
            const platform = {
                x: x,
                y: y,
                width: PLATFORM_WIDTH,
                height: PLATFORM_HEIGHT,
                color: '#93c5fd'
            };
            
            gameState.platforms.push(platform);
            gameState.lastPlatformY = y;
            
            // 40% шанс создать кристалл на платформе
            if (Math.random() < 0.4) {
                createCrystal(x + Math.random() * (PLATFORM_WIDTH - CRYSTAL_SIZE), y - CRYSTAL_SIZE);
            }
        }
        
        // Создание маленького облачка
        function createSmallCloud(x, y) {
            gameState.clouds.push({
                x: x,
                y: y,
                width: 60,
                height: 25,
                speed: 0.5
            });
        }
        
        // Создание облаков фона
        function createClouds() {
            gameState.clouds = [];
            
            // Создаем несколько облаков
            for (let i = 0; i < 10; i++) {
                gameState.clouds.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height / 2,
                    width: 60 + Math.random() * 80,
                    height: 20 + Math.random() * 30,
                    speed: 0.1 + Math.random() * 0.3
                });
            }
        }
        
        // Создание кристалла RCC
        function createCrystal(x, y) {
            gameState.crystals.push({
                x: x,
                y: y,
                width: CRYSTAL_SIZE,
                height: CRYSTAL_SIZE,
                collected: false,
                rotation: Math.random() * Math.PI * 2,
                rotationSpeed: 0.01 + Math.random() * 0.03,
                color: '#ec4899',
                glowColor: '#f472b6'
            });
        }
        
        // Обработка ввода
        function handleKeydown(e) {
            // Предотвращаем прокрутку страницы при нажатии пробела
            if (e.key === ' ' || e.key === 'ArrowUp') {
                e.preventDefault();
            }
            
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                gameState.keys.left = true;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                gameState.keys.right = true;
            }
            if ((e.key === ' ' || e.key === 'ArrowUp') && !gameState.keys.jump) {
                gameState.keys.jump = true;
            }
        }
        
        function handleKeyup(e) {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                gameState.keys.left = false;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                gameState.keys.right = false;
            }
            if (e.key === ' ' || e.key === 'ArrowUp') {
                gameState.keys.jump = false;
            }
        }
        
        // Обработка касаний для кнопок
        document.getElementById('leftButton').addEventListener('touchstart', (e) => {
            e.preventDefault();
            gameState.keys.left = true;
        });
        
        document.getElementById('leftButton').addEventListener('touchend', (e) => {
            e.preventDefault();
            gameState.keys.left = false;
        });
        
        document.getElementById('rightButton').addEventListener('touchstart', (e) => {
            e.preventDefault();
            gameState.keys.right = true;
        });
        
        document.getElementById('rightButton').addEventListener('touchend', (e) => {
            e.preventDefault();
            gameState.keys.right = false;
        });
        
        document.getElementById('jumpButton').addEventListener('touchstart', (e) => {
            e.preventDefault();
            gameState.keys.jump = true;
        });
        
        document.getElementById('jumpButton').addEventListener('touchend', (e) => {
            e.preventDefault();
            gameState.keys.jump = false;
        });
        
        // Обновленная функция скроллинга (адаптировано под game.html)
        function update() {
            if (gameState.gameOver) return;
            
            const player = gameState.player;
            
            // Движение игрока
            player.velX = 0;
            if (gameState.keys.left) player.velX = -5;
            if (gameState.keys.right) player.velX = 5;
            
            // Применение гравитации
            player.velY += GRAVITY;
            
            // Прыжок
            if (gameState.keys.jump && player.onGround) {
                player.velY = JUMP_FORCE;
                player.onGround = false;
                createJumpParticles();
            }
            
            // Обновление позиции
            player.x += player.velX;
            player.y += player.velY;
            
            // Обновление вращения игрока
            player.rotation += player.velX * 0.05;
            
            // Границы экрана
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - PLAYER_SIZE) player.x = canvas.width - PLAYER_SIZE;
            
            // Проверка столкновений с платформами
            player.onGround = false;
            
            gameState.platforms.forEach(platform => {
                if (
                    player.x < platform.x + platform.width &&
                    player.x + PLAYER_SIZE > platform.x &&
                    player.y + PLAYER_SIZE <= platform.y + platform.height &&
                    player.y + PLAYER_SIZE > platform.y &&
                    player.velY > 0
                ) {
                    player.velY = 0;
                    player.y = platform.y - PLAYER_SIZE;
                    player.onGround = true;
                }
            });
            
            // Проверка сбора кристаллов RCC
            gameState.crystals.forEach((crystal, index) => {
                if (
                    !crystal.collected &&
                    player.x < crystal.x + crystal.width &&
                    player.x + PLAYER_SIZE > crystal.x &&
                    player.y < crystal.y + crystal.height &&
                    player.y + PLAYER_SIZE > crystal.y
                ) {
                    crystal.collected = true;
                    gameState.rcc += 10;
                    document.getElementById('score').textContent = gameState.rcc;
                    createCollectEffect(crystal.x, crystal.y);
                }
            });
            
            // Обновление облаков
            gameState.clouds.forEach(cloud => {
                cloud.x += cloud.speed;
                if (cloud.x > canvas.width + 50) {
                    cloud.x = -50 - Math.random() * 50;
                }
            });
            
            // Смещение платформ вниз как в game.html
            if (player.y < canvas.height / 4) {
                const scrollAmount = SCROLL_SPEED;
                gameState.platforms.forEach(platform => platform.y += scrollAmount);
                gameState.crystals.forEach(crystal => crystal.y += scrollAmount);
                gameState.clouds.forEach(cloud => cloud.y += scrollAmount * 0.3);
                player.y += scrollAmount;
            }
            
            // Удаление платформ за пределами экрана и создание новых
            for (let i = gameState.platforms.length - 1; i >= 0; i--) {
                const platform = gameState.platforms[i];
                if (platform.y > canvas.height) {
                    gameState.platforms.splice(i, 1);
                    createPlatform();
                }
            }
            
            // Проверка на проигрыш
            if (player.y > canvas.height) {
                gameState.gameOver = true;
                document.getElementById('finalScore').textContent = gameState.rcc;
                document.getElementById('gameOverModal').classList.add('active');
            }
            
            // Создание новых частиц для фона
            if (Math.random() < 0.1) {
                createBackgroundParticle();
            }
            
            // Обновление частиц
            updateParticles();
        }
        
        // Создание эффекта при прыжке
        function createJumpParticles() {
            for (let i = 0; i < 8; i++) {
                gameState.particleEffects.push({
                    x: gameState.player.x + PLAYER_SIZE / 2,
                    y: gameState.player.y + PLAYER_SIZE,
                    size: 2 + Math.random() * 4,
                    velX: -3 + Math.random() * 6,
                    velY: -Math.random() * 3,
                    color: '#93c5fd',
                    life: 20 + Math.random() * 20
                });
            }
        }
        
        // Создание эффекта при сборе кристалла RCC
        function createCollectEffect(x, y) {
            for (let i = 0; i < 15; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 3;
                
                gameState.particleEffects.push({
                    x: x + CRYSTAL_SIZE / 2,
                    y: y + CRYSTAL_SIZE / 2,
                    size: 3 + Math.random() * 4,
                    velX: Math.cos(angle) * speed,
                    velY: Math.sin(angle) * speed,
                    color: '#ec4899',
                    life: 30 + Math.random() * 30
                });
            }
        }
        
        // Создание фоновых частиц
        function createBackgroundParticle() {
            gameState.particleEffects.push({
                x: Math.random() * canvas.width,
                y: canvas.height,
                size: 1 + Math.random() * 2,
                velX: -1 + Math.random() * 2,
                velY: -1 - Math.random() * 2,
                color: '#93c5fd',
                life: 100 + Math.random() * 100
            });
        }
        
        // Обновление частиц
        function updateParticles() {
            for (let i = gameState.particleEffects.length - 1; i >= 0; i--) {
                const particle = gameState.particleEffects[i];
                
                particle.x += particle.velX;
                particle.y += particle.velY;
                particle.life--;
                
                if (particle.life <= 0) {
                    gameState.particleEffects.splice(i, 1);
                }
            }
        }
        
        // Отрисовка игры
        function draw() {
            // Очистка canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Рисование фона
            drawBackground();
            
            // Рисование облаков
            drawClouds();
            
            // Рисование платформ
            gameState.platforms.forEach(platform => {
                drawPlatform(platform);
            });
            
            // Рисование кристаллов RCC
            gameState.crystals.forEach(crystal => {
                if (!crystal.collected) {
                    drawCrystal(crystal);
                }
            });
            
            // Рисование игрока
            drawPlayer();
            
            // Рисование частиц
            drawParticles();
        }
        
        // Рисование фона
        function drawBackground() {
            // Градиентный фон
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#1e293b');
            gradient.addColorStop(1, '#0f172a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Звезды
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 1.5;
                ctx.fillRect(x, y, size, size);
            }
        }
        
        // Рисование облаков
        function drawClouds() {
            gameState.clouds.forEach(cloud => {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.beginPath();
                ctx.arc(cloud.x, cloud.y, cloud.width * 0.3, 0, Math.PI * 2);
                ctx.arc(cloud.x + cloud.width * 0.25, cloud.y - cloud.height * 0.3, cloud.width * 0.2, 0, Math.PI * 2);
                ctx.arc(cloud.x + cloud.width * 0.5, cloud.y, cloud.width * 0.3, 0, Math.PI * 2);
                ctx.arc(cloud.x + cloud.width * 0.25, cloud.y + cloud.height * 0.3, cloud.width * 0.2, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // Рисование платформы (облака)
        function drawPlatform(platform) {
            ctx.fillStyle = platform.color;
            ctx.shadowColor = 'rgba(191, 219, 254, 0.5)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.roundRect(platform.x, platform.y, platform.width, platform.height, 15);
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        
        // Рисование игрока
        function drawPlayer() {
            const player = gameState.player;
            
            ctx.save();
            ctx.translate(player.x + PLAYER_SIZE / 2, player.y + PLAYER_SIZE / 2);
            ctx.rotate(player.rotation);
            
            // Градиент для игрока
            const gradient = ctx.createLinearGradient(-PLAYER_SIZE/2, -PLAYER_SIZE/2, PLAYER_SIZE, PLAYER_SIZE);
            gradient.addColorStop(0, '#6366f1');
            gradient.addColorStop(1, '#8b5cf6');
            
            ctx.fillStyle = gradient;
            
            // Скругление углов
            ctx.beginPath();
            ctx.roundRect(-PLAYER_SIZE/2, -PLAYER_SIZE/2, PLAYER_SIZE, PLAYER_SIZE, 8);
            ctx.fill();
            
            // Внутренняя подсветка
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.beginPath();
            ctx.roundRect(-PLAYER_SIZE/2 + 4, -PLAYER_SIZE/2 + 4, PLAYER_SIZE - 8, PLAYER_SIZE - 8, 5);
            ctx.fill();
            
            ctx.restore();
            
            // Облачко под игроком, если на земле
            if (player.onGround) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.beginPath();
                ctx.arc(player.x + PLAYER_SIZE/2, player.y + PLAYER_SIZE, 12, 0, Math.PI);
                ctx.fill();
            }
        }
        
        // Рисование кристалла RCC
        function drawCrystal(crystal) {
            crystal.rotation += crystal.rotationSpeed;
            const centerX = crystal.x + crystal.width / 2;
            const centerY = crystal.y + crystal.height / 2;
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(crystal.rotation);
            
            // Свечение кристалла RCC
            ctx.shadowColor = crystal.glowColor;
            ctx.shadowBlur = 20;
            
            // Основная форма кристалла RCC
            ctx.fillStyle = crystal.color;
            ctx.strokeStyle = '#f0abfc';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(0, -crystal.height/2);
            ctx.lineTo(crystal.width/3, 0);
            ctx.lineTo(0, crystal.height/2);
            ctx.lineTo(-crystal.width/3, 0);
            ctx.closePath();
            ctx.fill();
            
            // Центральная часть
            ctx.fillStyle = '#f5d0fe';
            ctx.beginPath();
            ctx.moveTo(0, -crystal.height/4);
            ctx.lineTo(crystal.width/6, 0);
            ctx.lineTo(0, crystal.height/4);
            ctx.lineTo(-crystal.width/6, 0);
            ctx.closePath();
            ctx.fill();
            
            ctx.stroke();
            ctx.restore();
        }
        
        
        // Рисование частиц
        function drawParticles() {
            gameState.particleEffects.forEach(particle => {
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = particle.life / 100;
                
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
            });
            
            ctx.globalAlpha = 1;
        }
        
        // Навигация с подтверждением
        function confirmNavigation(url) {
            const confirmation = confirm('Вы точно хотите покинуть игру? (После выхода ваш игровой режим не сохранится)');
            if (confirmation) {
                window.location.href = url;
            }
        }
        
        // Навигационные функции
        function goToMenu() {
            confirmNavigation('menu.html');
        }
        
        function goToShop() {
            confirmNavigation('shop.html');
        }
        
        function goToFriends() {
            confirmNavigation('friends.html');
        }
        
        function goToSkins() {
            confirmNavigation('skins.html');
        }
        
        // Перезапуск игры
        document.getElementById('restartButton').addEventListener('click', () => {
            gameState.rcc = 0;
            gameState.gameOver = false;
            document.getElementById('score').textContent = gameState.rcc;
            document.getElementById('gameOverModal').classList.remove('active');
            createInitialPlatform();
        });
        
        // Создаем звезды в модальном окне
        createModalStars();
        
        // Инициализируем игру
        createInitialPlatform();
        
        // Игровой цикл
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // Навешиваем обработчики событий
        window.addEventListener('keydown', handleKeydown);
        window.addEventListener('keyup', handleKeyup);
        
        // Предотвращаем прокрутку страницы при касании кнопок
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
            });
        });
        
        // Запускаем игровой цикл
        gameLoop();
        
        // Добавляем поддержку roundRect для старых браузеров
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + width, y, x + width, y + height, radius);
                this.arcTo(x + width, y + height, x, y + height, radius);
                this.arcTo(x, y + height, x, y, radius);
                this.arcTo(x, y, x + width, y, radius);
                this.closePath();
                return this;
            }
        }
    </script>
</body>
</html>